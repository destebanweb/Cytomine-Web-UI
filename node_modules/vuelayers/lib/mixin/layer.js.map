{"version":3,"file":"layer.js","sources":["src/mixin/layer.js"],"sourcesContent":["import uuid from 'uuid/v4'\nimport Vue from 'vue'\nimport { hasLayer, hasMap } from '../util/assert'\nimport { isEqual } from '../util/minilo'\nimport mergeDescriptors from '../util/multi-merge-descriptors'\nimport { observableFromOlEvent } from '../rx-ext'\nimport cmp from './ol-virt-cmp'\nimport sourceContainer from './source-container'\nimport useMapCmp from './use-map-cmp'\n\nconst props = {\n  id: {\n    type: [String, Number],\n    default: () => uuid(),\n  },\n  /**\n   * The bounding extent for layer rendering defined in the map view projection.\n   * The layer will not be rendered outside of this extent.\n   * @default undefined\n   * @type {Extent|number[]|undefined}\n   */\n  extent: {\n    type: Array,\n    validator: value => value.length === 4,\n  },\n  minResolution: Number,\n  maxResolution: Number,\n  opacity: {\n    type: Number,\n    default: 1,\n  },\n  overlay: {\n    type: Boolean,\n    default: false,\n  },\n  visible: {\n    type: Boolean,\n    default: true,\n  },\n  zIndex: Number,\n}\n\nconst methods = {\n  /**\n   * @return {Promise<Layer>}\n   * @protected\n   */\n  async createOlObject () {\n    let layer = await this.createLayer()\n    layer.set('id', this.id)\n\n    return layer\n  },\n  /**\n   * @return {Layer|Promise<Layer>}\n   * @protected\n   * @abstract\n   */\n  createLayer () {\n    throw new Error('Not implemented method')\n  },\n  /**\n   * @return {Promise<Vue<Layer>>}\n   * @protected\n   */\n  init () {\n    return this::cmp.methods.init()\n  },\n  /**\n   * @return {void|Promise<void>}\n   * @protected\n   */\n  deinit () {\n    return this::cmp.methods.deinit()\n  },\n  /**\n   * @param {number[]} pixel\n   * @return {boolean}\n   */\n  isAtPixel (pixel) {\n    hasMap(this)\n\n    return this.$map.forEachLayerAtPixel(pixel, l => l === this.$layer)\n  },\n  /**\n   * @returns {Object}\n   * @protected\n   */\n  getServices () {\n    const vm = this\n\n    return mergeDescriptors(\n      this::cmp.methods.getServices(),\n      this::sourceContainer.methods.getServices(),\n      {\n        get layer () { return vm.$layer },\n      },\n    )\n  },\n  /**\n   * @return {{\n   *     setSource: function(Source): void,\n   *     getSource: function(): Source\n   *   }|undefined}\n   * @protected\n   */\n  getSourceTarget () {\n    return this.$layer\n  },\n  /**\n   * @return {void}\n   * @protected\n   */\n  mount () {\n    if (this.overlay && this.$map) {\n      this.setMap(this.$map)\n    } else if (this.$layersContainer) {\n      this.$layersContainer.addLayer(this)\n    }\n\n    this.subscribeAll()\n  },\n  /**\n   * @return {void}\n   * @protected\n   */\n  unmount () {\n    this.unsubscribeAll()\n\n    if (this.overlay) {\n      this.setMap(undefined)\n    } else if (this.$layersContainer) {\n      this.$layersContainer.removeLayer(this)\n    }\n  },\n  /**\n   * Updates layer state\n   * @return {Promise}\n   */\n  refresh () {\n    return this::cmp.methods.refresh()\n  },\n  /**\n   * @param {Map|Vue|undefined} map\n   */\n  setMap (map) {\n    hasLayer(this)\n\n    map = map instanceof Vue ? map.$map : map\n    this.$layer.setMap(map)\n  },\n  subscribeAll () {\n    this::subscribeToLayerEvents()\n  },\n}\n\nconst watch = {\n  id (value) {\n    if (this.$layer && value !== this.$layer.get('id')) {\n      this.$layer.set('id', value)\n    }\n  },\n  maxResolution (value) {\n    if (this.$layer && value !== this.$layer.getMaxResolution()) {\n      this.$layer.setMaxResolution(value)\n    }\n  },\n  minResolution (value) {\n    if (this.$layer && value !== this.$layer.getMinResolution()) {\n      this.$layer.setMinResolution(value)\n    }\n  },\n  opacity (value) {\n    if (this.$layer && value !== this.$layer.getOpacity()) {\n      this.$layer.setOpacity(value)\n    }\n  },\n  visible (value) {\n    if (this.$layer && value !== this.$layer.getVisible()) {\n      this.$layer.setVisible(value)\n    }\n  },\n  zIndex (value) {\n    if (this.$layer && value !== this.$layer.getZIndex()) {\n      this.$layer.setZIndex(value)\n    }\n  },\n  extent (value) {\n    if (this.$layer && !isEqual(value, this.$layer.getExtent())) {\n      this.$layer.setExtent(value)\n    }\n  },\n}\n\nexport default {\n  mixins: [cmp, useMapCmp, sourceContainer],\n  props,\n  methods,\n  watch,\n  stubVNode: {\n    attrs () {\n      return {\n        id: [this.$options.name, this.id].join('-'),\n        class: this.$options.name,\n      }\n    },\n  },\n  created () {\n    Object.defineProperties(this, {\n      /**\n       * @type {Layer|undefined}\n       */\n      $layer: {\n        enumerable: true,\n        get: () => this.$olObject,\n      },\n      $map: {\n        enumerable: true,\n        get: () => this.$services && this.$services.map,\n      },\n      $view: {\n        enumerable: true,\n        get: () => this.$services && this.$services.view,\n      },\n      $layersContainer: {\n        enumerable: true,\n        get: () => this.$services && this.$services.layersContainer,\n      },\n    })\n  },\n}\n\nfunction subscribeToLayerEvents () {\n  hasLayer(this)\n\n  const events = observableFromOlEvent(this.$layer, [\n    'postcompose',\n    'precompose',\n    'render',\n  ])\n\n  this.subscribeTo(events, evt => this.$emit(evt.type, evt))\n}\n"],"names":["props","id","type","String","Number","default","uuid","extent","Array","validator","value","length","minResolution","maxResolution","opacity","overlay","Boolean","visible","zIndex","methods","createOlObject","createLayer","layer","set","Error","init","cmp","deinit","isAtPixel","pixel","hasMap","$map","forEachLayerAtPixel","l","$layer","getServices","vm","mergeDescriptors","sourceContainer","getSourceTarget","mount","setMap","$layersContainer","addLayer","subscribeAll","unmount","unsubscribeAll","undefined","removeLayer","refresh","map","hasLayer","Vue","subscribeToLayerEvents","watch","get","getMaxResolution","setMaxResolution","getMinResolution","setMinResolution","getOpacity","setOpacity","getVisible","setVisible","getZIndex","setZIndex","isEqual","getExtent","setExtent","mixins","useMapCmp","stubVNode","attrs","$options","name","join","class","created","enumerable","$olObject","$services","$view","view","layersContainer","events","observableFromOlEvent","subscribeTo","evt","$emit"],"mappings":"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"}