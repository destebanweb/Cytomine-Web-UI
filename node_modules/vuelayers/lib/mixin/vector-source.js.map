{"version":3,"file":"vector-source.js","sources":["src/mixin/vector-source.js"],"sourcesContent":["import { merge as mergeObs } from 'rxjs/observable'\nimport { debounceTime, tap } from 'rxjs/operators'\nimport { SourceCollectionAdapter } from '../ol-ext/collection'\nimport observableFromOlEvent from '../rx-ext/from-ol-event'\nimport * as assert from '../util/assert'\nimport mergeDescriptors from '../util/multi-merge-descriptors'\nimport featuresContainer from './features-container'\nimport projTransforms from './proj-transforms'\nimport source from './source'\n\nconst props = {\n  useSpatialIndex: {\n    type: Boolean,\n    default: true,\n  },\n}\n\nconst computed = {\n  featuresViewProj () {\n    if (this.rev && this.resolvedDataProjection && this.$source) {\n      return this.getFeatures().map(::this.writeFeatureInViewProj)\n    }\n    return []\n  },\n}\n\nconst methods = {\n  /**\n   * @return {void}\n   */\n  clear () {\n    this::featuresContainer.methods.clearFeatures()\n  },\n  /**\n   * @return {SourceCollectionAdapter}\n   * @protected\n   */\n  getFeaturesTarget () {\n    if (this._featuresTarget == null && this.$source) {\n      this._featuresTarget = new SourceCollectionAdapter(this.$source)\n    }\n\n    return this._featuresTarget\n  },\n  /**\n   * @return {Object}\n   * @protected\n   */\n  getServices () {\n    return mergeDescriptors(\n      this::source.methods.getServices(),\n      this::featuresContainer.methods.getServices(),\n    )\n  },\n  /**\n   * @return {Promise}\n   * @protected\n   */\n  init () {\n    return this::source.methods.init()\n  },\n  /**\n   * @return {void|Promise<void>}\n   * @protected\n   */\n  deinit () {\n    return this::source.methods.deinit()\n  },\n  /**\n   * @return {void}\n   * @protected\n   */\n  mount () {\n    this::source.methods.mount()\n  },\n  /**\n   * @return {void}\n   * @protected\n   */\n  unmount () {\n    this.clear()\n    this::source.methods.unmount()\n  },\n  /**\n   * @return {void}\n   * @protected\n   */\n  subscribeAll () {\n    this::subscribeToSourceChanges()\n  },\n  /**\n   * @param feature\n   * @return {ReadonlyArray<any>}\n   * @protected\n   */\n  writeFeatureInDataProj (feature) {\n    return this::projTransforms.methods.writeFeatureInDataProj(feature)\n  },\n  /**\n   * @param feature\n   * @return {ReadonlyArray<any>}\n   * @protected\n   */\n  writeGeometryInViewProj (feature) {\n    return this::projTransforms.methods.writeFeatureInViewProj(feature)\n  },\n}\n\nexport default {\n  mixins: [source, featuresContainer, projTransforms],\n  props,\n  computed,\n  methods,\n  stubVNode: {\n    empty: false,\n    attrs () {\n      return {\n        class: this.$options.name,\n      }\n    },\n  },\n}\n\nfunction subscribeToSourceChanges () {\n  assert.hasSource(this)\n\n  const add = observableFromOlEvent(this.$source, 'addfeature').pipe(\n    tap(({ feature }) => {\n      this.addFeature(feature)\n    }),\n  )\n  const remove = observableFromOlEvent(this.$source, 'removefeature').pipe(\n    tap(({ feature }) => {\n      this.removeFeature(feature)\n    }),\n  )\n  const changeFeature = observableFromOlEvent(this.$source, 'changefeature')\n\n  const events = mergeObs(add, remove, changeFeature)\n\n  this.subscribeTo(events, evt => {\n    ++this.rev\n    this.$emit(evt.type, evt)\n  })\n  // emit event to allow `sync` modifier\n  this.subscribeTo(events.pipe(debounceTime(100)), () => {\n    this.$emit('update:features', this.getFeatures().map(::this.writeFeatureInDataProj))\n  })\n}\n"],"names":["props","useSpatialIndex","type","Boolean","default","computed","featuresViewProj","rev","resolvedDataProjection","$source","getFeatures","map","writeFeatureInViewProj","methods","clear","featuresContainer","clearFeatures","getFeaturesTarget","_featuresTarget","SourceCollectionAdapter","getServices","mergeDescriptors","source","init","deinit","mount","unmount","subscribeAll","subscribeToSourceChanges","writeFeatureInDataProj","feature","projTransforms","writeGeometryInViewProj","mixins","stubVNode","empty","attrs","class","$options","name","assert","add","observableFromOlEvent","pipe","tap","addFeature","remove","removeFeature","changeFeature","events","mergeObs","subscribeTo","evt","$emit","debounceTime"],"mappings":";;;;;;;;;;;;;;;;;;;;;AAUA,IAAMA,KAAK,GAAG;EACZC,eAAe,EAAE;IACfC,IAAI,EAAEC,OADS;IAEfC,OAAO,EAAE;;CAHb;AAOA,IAAMC,QAAQ,GAAG;EACfC,gBADe,8BACK;QACd,KAAKC,GAAL,IAAY,KAAKC,sBAAjB,IAA2C,KAAKC,OAApD,EAA6D;aACpD,KAAKC,WAAL,GAAmBC,GAAnB,CAAyB,KAAKC,sBAA9B,MAAyB,IAAzB,EAAP;;;WAEK,EAAP;;CALJ;AASA,IAAMC,OAAO,GAAG;;;;EAIdC,KAJc,mBAIL;IACDC,iBAAiB,CAACF,OAAlB,CAA0BG,aAAhC;GALY;;;;;;EAWdC,iBAXc,+BAWO;QACf,KAAKC,eAAL,IAAwB,IAAxB,IAAgC,KAAKT,OAAzC,EAAkD;WAC3CS,eAAL,GAAuB,IAAIC,uBAAJ,CAA4B,KAAKV,OAAjC,CAAvB;;;WAGK,KAAKS,eAAZ;GAhBY;;;;;;EAsBdE,WAtBc,yBAsBC;WACNC,gBAAgB,CACfC,MAAM,CAACT,OAAP,CAAeO,WAArB,WADqB,EAEfL,iBAAiB,CAACF,OAAlB,CAA0BO,WAAhC,WAFqB,CAAvB;GAvBY;;;;;;EAgCdG,IAhCc,kBAgCN;WACOD,MAAM,CAACT,OAAP,CAAeU,IAArB,WAAP;GAjCY;;;;;;EAuCdC,MAvCc,oBAuCJ;WACKF,MAAM,CAACT,OAAP,CAAeW,MAArB,WAAP;GAxCY;;;;;;EA8CdC,KA9Cc,mBA8CL;IACDH,MAAM,CAACT,OAAP,CAAeY,KAArB;GA/CY;;;;;;EAqDdC,OArDc,qBAqDH;SACJZ,KAAL;IACMQ,MAAM,CAACT,OAAP,CAAea,OAArB;GAvDY;;;;;;EA6DdC,YA7Dc,0BA6DE;IACRC,wBAAN;GA9DY;;;;;;;EAqEdC,sBArEc,kCAqEUC,OArEV,EAqEmB;WAClBC,cAAc,CAAClB,OAAf,CAAuBgB,sBAA7B,YAAoDC,OAApD,CAAP;GAtEY;;;;;;;EA6EdE,uBA7Ec,mCA6EWF,OA7EX,EA6EoB;WACnBC,cAAc,CAAClB,OAAf,CAAuBD,sBAA7B,YAAoDkB,OAApD,CAAP;;CA9EJ;AAkFA,mBAAe;EACbG,MAAM,EAAE,CAACX,MAAD,EAASP,iBAAT,EAA4BgB,cAA5B,CADK;EAEb/B,KAAK,EAALA,KAFa;EAGbK,QAAQ,EAARA,QAHa;EAIbQ,OAAO,EAAPA,OAJa;EAKbqB,SAAS,EAAE;IACTC,KAAK,EAAE,KADE;IAETC,KAFS,mBAEA;aACA;QACLC,KAAK,EAAE,KAAKC,QAAL,CAAcC;OADvB;;;CARN;;AAeA,SAASX,wBAAT,GAAqC;;;EACnCY,SAAA,CAAiB,IAAjB;MAEMC,GAAG,GAAGC,qBAAqB,CAAC,KAAKjC,OAAN,EAAe,YAAf,CAArB,CAAkDkC,IAAlD,CACVC,GAAG,CAAC,gBAAiB;QAAdd,OAAc,QAAdA,OAAc;;IACnB,KAAI,CAACe,UAAL,CAAgBf,OAAhB;GADC,CADO,CAAZ;MAKMgB,MAAM,GAAGJ,qBAAqB,CAAC,KAAKjC,OAAN,EAAe,eAAf,CAArB,CAAqDkC,IAArD,CACbC,GAAG,CAAC,iBAAiB;QAAdd,OAAc,SAAdA,OAAc;;IACnB,KAAI,CAACiB,aAAL,CAAmBjB,OAAnB;GADC,CADU,CAAf;MAKMkB,aAAa,GAAGN,qBAAqB,CAAC,KAAKjC,OAAN,EAAe,eAAf,CAA3C;MAEMwC,MAAM,GAAGC,KAAQ,CAACT,GAAD,EAAMK,MAAN,EAAcE,aAAd,CAAvB;OAEKG,WAAL,CAAiBF,MAAjB,EAAyB,UAAAG,GAAG,EAAI;MAC5B,KAAI,CAAC7C,GAAP;;IACA,KAAI,CAAC8C,KAAL,CAAWD,GAAG,CAAClD,IAAf,EAAqBkD,GAArB;GAFF,EAjBmC;;OAsB9BD,WAAL,CAAiBF,MAAM,CAACN,IAAP,CAAYW,YAAY,CAAC,GAAD,CAAxB,CAAjB,EAAiD,YAAM;IACrD,KAAI,CAACD,KAAL,CAAW,iBAAX,EAA8B,KAAI,CAAC3C,WAAL,GAAmBC,GAAnB,CAAyB,KAAI,CAACkB,sBAA9B,MAAyB,KAAzB,EAA9B;GADF;;;;;"}