{"version":3,"file":"ol-cmp.js","sources":["src/mixin/ol-cmp.js"],"sourcesContent":["import { interval as intervalObs } from 'rxjs/observable'\nimport { first as firstObs, map as mapObs, skipWhile } from 'rxjs/operators'\nimport debounce from 'debounce-promise'\nimport { isFunction } from '../util/minilo'\nimport identMap from './ident-map'\nimport rxSubs from './rx-subs'\nimport services from './services'\n\nconst VM_PROP = 'vm'\nconst INSTANCE_PROMISE_POOL = 'instance_promise'\n/**\n * @vueProps\n */\nconst props = {}\n/**\n * @vueMethods\n */\nconst methods = {\n  /**\n   * @return {Promise<void>}\n   * @protected\n   */\n  beforeInit () {},\n  /**\n   * @return {Promise} Resolves when initialization completes\n   * @protected\n   */\n  async init () {\n    let createPromise\n\n    const ident = this.makeSelfIdent()\n    if (ident && this.$identityMap.has(ident, INSTANCE_PROMISE_POOL)) {\n      createPromise = this.$identityMap.get(ident, INSTANCE_PROMISE_POOL)\n    } else {\n      createPromise = Promise.resolve(this.createOlObject())\n\n      if (ident) {\n        this.$identityMap.set(ident, createPromise, INSTANCE_PROMISE_POOL)\n      }\n    }\n\n    this._olObject = await createPromise\n    this._olObject[VM_PROP] || (this._olObject[VM_PROP] = [])\n\n    if (!this._olObject[VM_PROP].includes(this)) { // for loaded from IdentityMap\n      this._olObject[VM_PROP].push(this)\n    }\n\n    ++this.rev\n  },\n  /**\n   * @return {*|Promise<T>}\n   * @protected\n   * @abstract\n   */\n  createOlObject () {\n    throw new Error('Not implemented method')\n  },\n  /**\n   * @return {void|Promise<void>}\n   * @protected\n   */\n  deinit () {\n    const ident = this.makeSelfIdent()\n    if (ident) {\n      this.$identityMap.unset(ident, INSTANCE_PROMISE_POOL)\n    }\n    if (this._olObject) {\n      this._olObject[VM_PROP] = this._olObject[VM_PROP].filter(vm => vm !== this)\n      this._olObject = undefined\n    }\n  },\n  /**\n   * Redefine for easy call in child components\n   * @returns {Object}\n   * @protected\n   */\n  getServices () {\n    return this::services.methods.getServices()\n  },\n  /**\n   * @return {void|Promise<void>}\n   * @protected\n   * @abstract\n   */\n  mount () {\n    throw new Error('Not implemented method')\n  },\n  /**\n   * @return {void|Promise<void>}\n   * @protected\n   * @abstract\n   */\n  unmount () {\n    throw new Error('Not implemented method')\n  },\n  /**\n   * Refresh internal ol objects\n   * @return {Promise<void>}\n   */\n  refresh () {\n    if (this.$olObject == null) return Promise.resolve()\n\n    return new Promise(resolve => {\n      let done = () => {\n        ++this.rev\n        resolve()\n      }\n      if (this.$olObject && isFunction(this.$olObject.changed)) {\n        this.$olObject.once('change', done)\n        this.$olObject.changed()\n      } else {\n        done()\n      }\n    })\n  },\n  /**\n   * Internal usage only in components that doesn't support refreshing.\n   * @return {Promise<void>}\n   * @protected\n   */\n  remount () {\n    if (this.$olObject == null) return Promise.resolve()\n\n    return Promise.resolve(this.unmount())\n      .then(() => this.mount())\n  },\n  /**\n   * Only for internal purpose to support watching for properties\n   * for which OpenLayers doesn't provide setters.\n   * @return {Promise}\n   * @protected\n   */\n  recreate () {\n    if (this.$olObject == null) return Promise.resolve()\n\n    return Promise.resolve(this.unmount())\n      .then(() => this.deinit())\n      .then(() => this.init())\n      .then(() => this.mount())\n  },\n}\n\n/**\n * Basic ol component mixin.\n *\n * @title olCmp\n * @vueProto\n * @alias module:mixin/ol-cmp\n *\n * @fires module:mixin/ol-cmp#created\n * @fires module:mixin/ol-cmp#mounted\n * @fires module:mixin/ol-cmp#destroyed\n */\nexport default {\n  VM_PROP,\n  INSTANCE_PROMISE_POOL,\n  mixins: [identMap, rxSubs, services],\n  props,\n  methods,\n  /**\n   * @this module:mixin/ol-cmp\n   */\n  data () {\n    return /** @lends module:mixin/ol-cmp# */{\n      rev: 0,\n    }\n  },\n  created () {\n    /**\n     * @type {*}\n     * @private\n     */\n    this._olObject = undefined\n    /**\n     * @type {Promise<Vue<T>>}\n     * @private\n     */\n    this._createPromise = Promise.resolve(this.beforeInit())\n      .then(this.init)\n      .then(() => {\n        // logdbg('created', this.$options.name)\n        this.$emit('created', this)\n        return this\n      })\n    /**\n     * @type {Promise<Vue<T>>}\n     * @private\n     */\n    this._mountPromise = intervalObs(100).pipe(\n      skipWhile(() => !this._mounted),\n      firstObs(),\n      mapObs(() => this),\n    ).toPromise(Promise)\n\n    Object.defineProperties(this, {\n      $olObject: {\n        enumerable: true,\n        get: () => this._olObject,\n      },\n      $createPromise: {\n        enumerable: true,\n        get: () => this._createPromise,\n      },\n      $mountPromise: {\n        enumerable: true,\n        get: () => this._mountPromise,\n      },\n    })\n\n    // bind debounced functions at runtime\n    // for each instance to avoid interfering between\n    // different instances\n    this.scheduleRefresh = debounce(function () {\n      return this.refresh()\n    }, 10)\n    this.scheduleRemount = debounce(function () {\n      return this.remount()\n    }, 10)\n    this.scheduleRecreate = debounce(function () {\n      return this.recreate()\n    }, 10)\n  },\n  mounted () {\n    this.$createPromise.then(this.mount)\n      .then(() => {\n        this._mounted = true\n        this.$emit('mounted', this)\n        // logdbg('mounted', this.$options.name)\n      })\n  },\n  destroyed () {\n    this.$mountPromise.then(this.unmount)\n      .then(this.deinit)\n      .then(() => {\n        this.$emit('destroyed', this)\n        // logdbg('destroyed', this.$options.name)\n      })\n  },\n}\n\n/**\n * Emitted when underlying **OpenLayers** instance created.\n * @event module:mixin/ol-cmp#created\n * @type {void}\n */\n/**\n * Emitted when underlying **OpenLayers** instance mounted to parent.\n * @event module:mixin/ol-cmp#mounted\n * @type {void}\n */\n/**\n * Emitted when underlying **OpenLayers** instance destroyed.\n * @event module:mixin/ol-cmp#destroyed\n * @type {void}\n */\n"],"names":["VM_PROP","INSTANCE_PROMISE_POOL","props","methods","beforeInit","init","ident","makeSelfIdent","$identityMap","has","createPromise","get","resolve","createOlObject","set","_olObject","includes","push","rev","Error","deinit","unset","filter","vm","undefined","getServices","services","mount","unmount","refresh","$olObject","done","isFunction","changed","once","remount","then","recreate","mixins","identMap","rxSubs","data","created","_createPromise","$emit","_mountPromise","intervalObs","pipe","skipWhile","_mounted","firstObs","mapObs","toPromise","enumerable","$createPromise","$mountPromise","scheduleRefresh","debounce","scheduleRemount","scheduleRecreate","mounted","destroyed"],"mappings":"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"}